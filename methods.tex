\section{Methods}
\subsection{Chain-level Dataset Filters}
Our previous rotamer library \cite{lovell2000penultimate} used the Top500 quality-filtered data \citep{Lovell:2003uq} as its reference dataset. Since then the number of high-resolution structures in the PDB has skyrocketed, allowing us to create a new quality-filtered, X-ray model database, the Top8000. The Top8000 was curated by assessing all PDB crystal structures as of March 29, 2011 with a protein chain of $\ge$ 38 residues at $<$ 2.0 \AA{} resolution. Hydrogens were added to each PDB file using Reduce, including Asn, Gln, and His flip corrections \citep{Word19991735}. MolProbity analysis was performed on each chain \citep{Chen:2010kx} and the results entered into a MySQL database. The chains were additionally filtered on the following criteria: chain MolProbity score $<$ 2.0, $\le$ 5\% of residues with bond length outliers ($>$ 4$\sigma$), $\le$ 5\% of residues with bond angle outliers ($>$ 4$\sigma$), and $\le$ 5\% of residues with C$\beta$ deviation outliers ($>$ 0.25\AA{}).

In order to control redundancy in the dataset, we made use of the PDB homology clusters, taken separately for 50\% sequence identity (most stringent similarity filtering), 70\%, 90\%, and 95\%. For each homology cluster, we selected the best chain based on the average of resolution and chain MolProbity score. This scoring scheme produced ties within some clusters (for $<$ 1\% of the final chain tallies); these were resolved, arbitrarily but reproducibly, by alphabetical order of PDB ID + single-character chain ID. At each homology level, a second list was chosen with the additional requirement of deposited structure-factor data. All 8 chain lists are available on GitHub \citep{Dabbish:2012} (e.g. file \texttt{Top8000-SFbest\_hom70\_pdb\_chain\_list.csv}, at \url{http://github.com/rlabduke/reference_data}). The "SF" lists are somewhat smaller, since some clusters may include no otherwise-acceptable structures with deposited data. At the 70\% similarity level optimal for most data-mining purposes, the Top8000-SFbest\_hom70 list contains 7,419 chains and the Top8000-best\_hom70 list contains 7,957 chains. This entire set of datasets is therefore nicknamed the "Top8000" of structural biology's upper class.

All rotamer statistical analysis presented here used the Top8000-SFbest\_hom70 dataset version. Deposited structure factors not only are required for electron-density based residue filtering, but they also enable examination of the model in the density map for individual examples of conformations deemed dubious or interesting. Of the 7,419 chains, 28 failed in the RSCC calculation described below, and 175 were dropped because $\le$ 20\% of their residues remained after residue-level filtering. The final rotamer dataset of 7,216 chains is listed in the supplementary material.


\subsection{Residue-level Dataset Filters}
\label{sec:resfilters}
Although the chain-level filters select for structures with high overall quality, local quality varies considerably within any model. In this context, \emph{quality} refers to canonical macromolecular model validation criteria (sterics, geometry, and conformation) as well as the fit to electron density. An important aspect of this research is to include only amino-acid sidechains with sufficiently clear electron density to justify their given conformation. Our previous rotamer library was based on the Top500 dataset where only two residue-level filters were used: no clashes and no B factors $\ge$ 40 \AA\textsuperscript{2}. The B factor filter was then (in 2003) our best available proxy for electron-density quality; however, residues with dubious sidechain density still remained. To remedy this, the current dataset was also filtered by a local real-space correlation coefficient (RSCC) metric and by local map value.

\begin{equation}
RSCC = \frac{\sum_{i=1}^{n} \left ( o_{i} - \bar{o} \right )\left ( c_{i} - \bar{c} \right )}{\sqrt{\sum_{i=1}^{n} \left ( o_{i} - \bar{o} \right )^{2} \ast \sum_{i=1}^{n}\left ( c_{i} - \bar{c} \right )^{2}}}
\label{rscceq}
\end{equation}

The local RSCC looks at the correlation between the $\sigma_{A}$-weighted \EDmap{} and the F$_{c}$ (calculated from model) electron density maps for a given local region, in this case, around each individual atom. Equation \ref{rscceq} shows how the RSCC was calculated. $o$ and $c$ are $\sigma$ values at grid points in the \EDmap{} and the F$_{c}$ maps, respectively, in a radius around the atom. The radius used is resolution dependent; a 1\AA{} radius is used for resolutions below 1\AA{} and a 1.5\AA{} radius is used for resolutions between 1\AA{} and 2\AA{}. $n$ is the number of grid points in the selected region and $\bar{o}$ and $\bar{c}$ are the local mean values for $o$ and $c$, respectively. The RSCC alone is not an adequate density-fit metric for our purposes. However, local RSCC (for shape), local \EDmap{} $\sigma$ value at the atom coordinate (for height), and B factor (for spread) together create a satisfactory fit-to-density metric. We used \textit{phenix.real\_space\_correlation} in the \textit{PHENIX} software package \citep{Adams:2010fk} to calculate the RSCC and \EDmap{} $\sigma$ values at each atom for all structures in the Top8000. Per-residue filter values were then assigned by taking the worst atom B (greatest value), worst atom RSCC (least value), and worst atom \EDmap{} $\sigma$ value (least value) in each residue.

In selecting filter thresholds for the dataset, we had the goal of keeping a large number of residues while reliably eliminating those with dubious density. To do this, we analyzed the counts of residues remaining for several combinations of filter thresholds. The best balance between filter levels and a reasonably large number of residues yielded the following thresholds: worst B factor $<$ 40, worst correlation coefficient $>$ 0.7, and worst map value $>$ 1.1. Upon visual inspection of residues and maps close to these filter thresholds, we determined that the selected combination of thresholds was indeed effective at keeping only residues with satisfactory electron density. Additionally, residues were required to have no all-atom clashes, an occupancy of 1.0, B factors $>$ 1.0 and all backbone atoms modeled, achieved indirectly by ensuring that $\phi$, $\psi$, $\omega$ and $\tau$ were defined for each residue.  The latter test also drops sidechains of the first and last residue in each chain, which are somewhat less and differently affected by backbone interactions.

After all filters, the final reference dataset for this work contains more than a million residues, 983,574 of which are rotamer-relevant, non-Gly non-Ala residues. A csv file of all 983,574 residues in the rotamer-relevant reference dataset is available on GitHub (See \texttt{datasets/Top8000\_rotamer\_residues.csv} at \url{http://github.com/rlabduke/reference_data}).

\subsection{Determination of Distributions, Scores, and Contours}
\label{sec_md:contours}
The described rotamer library's primary use is for validation of sidechains in protein models, which flags an outlier if the sidechain has an extremely rare (and presumably high-energy) conformation. This assessment requires a scoring system based upon the multi-dimensional distribution of observed conformations in our high-quality, residue-filtered reference data. We have taken great care to ensure smooth, accurate, and robust contours dividing outlier from allowed. To achieve this we calculated smooth distributions in the multi-dimensional $\chi$ space for each residue type, using an adaptive local-density-dependent kernel density estimation (KDE) \textcolor{red}{\cite{Breiman1977}}. Our method has two steps, both using a cosine kernel normalized to have an area or volume of 1.0. A cosine is used, rather than a gaussian, because it reaches zero at a well-defined edge. In the first step, the width of each cosine kernel is 5$^{\circ}$. In the second step, the width of the kernel is varied, dependent on the density at that location, as calculated in the first step. Kernel widths are wider in sparse regions and narrower as density increases. The consequence of this is distributions that remain smooth in sparse regions but preserve the sharp transitions where occurrence frequency falls off quickly. A full explanation of this method can be found in \cite{Lovell:2003uq}. The distributions are stored as a discrete grid in $\chi$ space with coordinates and KDE values. Grid spacing is dependent on dimension number: in order of $\chi$ dimensions, 1-4, the grid spacings are 1, 5, 8, and 10 degrees. Each datapoint residue can be assigned a value by interpolating its $\chi$ values within the grid. One can then determine what grid value is just greater than for the lowest, say, 1\% of the quality-filtered reference data. The grid values are then rescaled to represent those percentage values, which are known as the \textit{rotamericity} of a sidechain conformation, or simply as the rotamer score. The rotamer-score grids are used in \textit{PHENIX} validation (GUI, \texttt{phenix.rotalyze}, and \texttt{phenix.molprobity}) and the MolProbity web service, and they are available as plain-text numerical arrays on GitHub, under \texttt{datasets/Top8000\_rotamer\_pct\_contour\_grids} at \url{http://github.com/rlabduke/reference_data}.

To visualize the rotamer distributions, smooth contours are drawn at chosen levels using our internal programs Silk, kin2Dcont, and kin3Dcont \cite{Thesis:Word,Thesis:Davis}. For the 4-dimensional Lys and Arg cases, the 3-D plots for $\chi$1\textbf{m}, $\chi$1\textbf{t}, and $\chi$1\textbf{p} are shown separately. For validation purposes, the interpolated grid value of a given multi-$\chi$ conformation is its rotamer score. In the new system developed here, a score of $\le$0.3\% qualifies as a rotamer outlier -- its score is worse than 99.7\% of the good data. Scores $>$0.3\% and $<$ 2.0\% are considered \textit{allowed} while those $\ge$2.0\% are considered \textit{favored}, as is traditional for Ramachandran criteria \citep{Laskowski:gl0276,Lovell:2003uq}.

\subsection{$\chi$ and Covalent Bond Angle Statistics}
\label{sec_md:chi_stats}
Maximum rotamer ranges were defined manually for each $\chi$ dimension by inspecting the smoothed contours (See \ref{sec_md:contours}) and placing boundaries at saddle points between rotamers or to reasonably encompass the rotamer well. To avoid wrapping complications, circular statistics were used (See Equations \ref{circ_xy} and \ref{circ_s}); this is important for $\chi$ distributions that cross zero, such as Asp \textbf{p0} and \textbf{m-30}, or for rotamers near 90$^{\circ}$ in symmetric aromatics. For each rotamer, we report a central value and a standard deviation ($\sigma$), for both dihedral $\chi$ values and covalent bond angles. The mean for the bond angles (Equation \ref{circ_m}) and the $\sigma$ for both $\chi$ and bond angles (Equation \ref{circ_s}) are calculated straightforwardly from the measures of each example in the filtered Top8000. Because of complex shapes, the central value for the $\chi$ measures is the center-of-mass (COM) in the contoured data. This is found by collecting the stored contour grid points in each rotamer well and, for each dimension, calculating the COM (Equation \ref{circ_com}).

\begin{equation}
\bar{x} = \frac{\sum_{i=1}^{n}\left ( \sin \theta_{i} \right )}{n}
\textrm{, }
\bar{y} = \frac{\sum_{i=1}^{n}\left ( \cos \theta_{i} \right )}{n}
\label{circ_xy}
\end{equation}

\begin{equation}
\sigma = \sqrt{-2 \ln \left ( \sqrt{\bar{x}^{2} + \bar{y}^{2}} \right )}
\label{circ_s}
\end{equation}

\begin{equation}
\textrm{mean} = \arctan\left (
\frac{\bar{x}}{\bar{y}}
\right )
\label{circ_m}
\end{equation}

\begin{equation}
\textrm{COM} = \arctan\left (
  \dfrac{
    \dfrac{\sum_{i=1}^{n}\left ( \sin \theta_{i} \right )\ast w_{i}}{W}
  }{
    \dfrac{\sum_{i=1}^{n} \left ( \cos \theta_{i} \right )\ast w_{i}}{W}
  }
\right )
\label{circ_com}
\end{equation}

\noindent where $n$ is the number of grid points, $\theta_{i}$ is the $i^{th}$ $\chi$ coordinate in radians, $w_{i}$ is the KDE value at the $i^{th}$ coordinate and $W$ is the sum of all KDE values in the rotamer well. To avoid wrapping issues when working with angular data, circular statistics breaks angle measures into its two unit circle components, $x$ and $y$. This is part of what is being done in Equation \ref{circ_xy}, where $\bar{x}$ and $\bar{y}$ are the average $x$ and $y$ components, respectively, for all angular measures, $\theta$. In Equation \ref{circ_com}, a weighted average of the $x$ and $y$ components is being calculated. The arctan function simply takes the $\bar{x}$ and $\bar{y}$ components and returns the corresponding angular value.

\subsection{Rotamer Assignment and Score}
\label{sec_md:rotaassign}
For the purpose of setting the appropriate contour level for the outlier cutoff, a large test dataset was created from all PDBs in the Top8000 by including all chains and all residues in each PDB file (as a surrogate for entire new PDB files later being validated), hereafter called the unfiltered dataset. \textit{phenix.rotalyze} was used to assign rotamer names and scores for each residue in the unfiltered dataset. The score is calculated from the individual residue's $\chi$ values, by interpolating over the nearest contour grid points (see section \ref{sec_md:contours}). This was done twice, once using the new Top8000 contours and once using our previous Top500 contours. If the score is above the outlier threshold, then a rotamer name is assigned based on which rotamer well the given $\chi$ angles fall within (the maximum well ranges were described in Section \ref{sec_md:chi_stats}). Otherwise the side-chain conformation is classified as an \textit{outlier}.